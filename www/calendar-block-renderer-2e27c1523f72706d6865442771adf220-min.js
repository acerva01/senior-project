YUI.add("squarespace-calendar-core-renderer",function(b){var e=function(a){return a.recordType===b.Squarespace.ContentConstants.EVENT?a.startDate:a.addedOn};b.Squarespace.SquarespaceCalendar=b.Base.create("SquarespaceCalendar",b.Calendar,[],{initializer:function(){this._fetchEvents()},bindUI:function(){b.Calendar.superclass.bindUI.call(this);this.before("dateChange",this._clearEvents,this);this.after("dateChange",this._fetchEvents,this);this.after("collectionIdChange",this._fetchEvents,this)},_clearEvents:function(){this.set("events",
[])},_fetchEvents:function(){var a=this.get("date"),a=b.DataType.Date.format(a,{format:"%B-%Y",locale:"en"});b.Data.get({url:this._getFetchUrl(a),success:this._parseResponse,failure:this._handleResponseError},this)},_parseResponse:function(a){this.set("events",a)},_handleResponseError:function(a){console.error("Failed fetch data: "+a);(new b.Squarespace.Alert).show("Server Request Failed","Failed to get calender data, "+a.message)},_getFetchUrl:function(a){return"/api/open/GetItemsByMonth?collectionId="+
this.get("collectionId")+"&month="+a}},{ATTRS:{events:{value:[],validator:b.Lang.isArray},collectionId:{value:null,validator:b.Lang.isString}}});b.Squarespace.CalendarBaseRenderer=b.Base.create("CalendarBaseRenderer",b.Plugin.Base,[],{initializer:function(a){this.host=a.host;this.afterHostEvent("eventsChange",this._onEventsChange,this)},_onEventsChange:function(a){var d=null;b.Lang.isArray(a.newVal)&&0<a.newVal.length&&(d=b.bind(this._calendarFilterFunction,this));this.host.set("customRenderer",{rules:{all:"events"},
filterFunction:d})},_calendarFilterFunction:function(a,b,c){c=this.host.get("events");c=this._getEventsOfDay(c,a);this._sortEvents(c);this._renderDay(a,b,c)},_renderDay:function(a,b,c){0<c.length&&b.setStyle("background","gray")},_sortEvents:function(a){a.sort(function(a,b){var f=e(a);return e(b)-f})},_getEventsOfDay:function(a,d){var c=b.DataType.Date.format(d,{format:"%Y-%m-%d"});return b.Lang.isArray(a)&&0<a.length?b.Array.filter(a,function(a){return this._isEventPartOfDay(a,c)},this):[]},_isEventPartOfDay:function(a,
d){var c,f;if(a.recordType!==b.Squarespace.ContentConstants.EVENT)return c=b.Squarespace.Utils.dateFormat(a.addedOn,{format:"%Y-%m-%d"}),c===d;c=b.Squarespace.Utils.dateFormat(a.startDate,{format:"%Y-%m-%d"});f=b.Squarespace.Utils.dateFormat(a.endDate,{format:"%Y-%m-%d"});return d==c||d==f||new Date(d)>new Date(c)&&new Date(d)<new Date(f)?!0:!1},_getEventDisplayTime:function(a){a=e(a);return b.Squarespace.Utils.dateFormat(a,{format:"%l:%M%P"}).trim()},_isSameDay:function(a,d){if(a.recordType!==b.Squarespace.ContentConstants.EVENT)return!0;
var c=b.Squarespace.Utils.dateFormat(a.startDate,{format:"%Y-%m-%d"}),f=b.DataType.Date.format(d,{format:"%Y-%m-%d"});return c===f}},{NS:"calendarPlugin"})},"1.0",{requires:["calendar","node","squarespace-ui-base"]});
YUI.add("squarespace-calendar-block-renderer",function(b){b.namespace("Y.Squarespace.Rendering");var e=b.Base.create("SqspCalendarPlugin",b.Squarespace.CalendarBaseRenderer,[],{initializer:function(a){this.host.get("contentBox").delegate("hover",this._onHover,this._onHoverOut,".yui3-calendar-day",this)},_renderDay:function(a,d,c){0<c.length&&(a=this._groupEvents(c,a),a=this._createFlyoutNode(a),d.addClass("date-has-event"),d.append(b.Node.create(e.TEMPLATE_DAY_MARKER)),d.append(a))},_onHover:function(a){a=
a.target;var b=a.one(".event-menu"),c=this.host.get("contentBox");b&&(b.show(),b.get("offsetWidth")+a.getX()>c.getX()+c.get("offsetWidth")&&b.addClass("event-menu-right"))},_onHoverOut:function(a){a=a.target;(a=a.hasClass("event-menu")?a:a.one(".event-menu"))&&a.hide()},_groupEvents:function(a,d){var c={},f=[],e=[];b.Array.each(a,function(a){if(this._isSameDay(a,d)){var b=this._getEventDisplayTime(a),e=c[b];e||(e=[],c[b]=e);e.push(a)}else f.push(a)},this);b.Object.each(c,function(a,b){e.splice(0,
0,{displayTime:b,events:a})});0<f.length&&e.splice(0,0,{displayTime:"(from previous day)",events:f});return e},_createFlyoutNode:function(a){var d=b.Node.create(e.TEMPLATE_FLYOUT);b.Array.each(a,function(a){var f=b.Node.create(b.substitute(e.TEMPLATE_GROUP_NODE,{displayTime:a.displayTime}));d.append(f);b.Array.each(a.events,function(a){a=b.substitute(e.TEMPLATE_EVENT_NODE,{fullUrl:a.fullUrl,title:a.title});f.append(a)})});d.hide();return d}},{TEMPLATE_DAY_MARKER:'<div class="date-has-event-marker"></div>',
TEMPLATE_FLYOUT:'<div class="event-menu">',TEMPLATE_GROUP_NODE:'<div class="event-time-group" title="{displayTime}"><div class="event-time">{displayTime}</div></div>',TEMPLATE_EVENT_NODE:'<div class="event-item"><a class="event-link" href="{fullUrl}">{title}</a></div>',NS:"calendarPlugin"});b.namespace("Squarespace.Rendering").renderCalendar=function(a,d){var c=new b.Squarespace.SquarespaceCalendar({contentBox:a,date:new Date,collectionId:d.collectionId});c.plug(e);c.render();return c};Squarespace.onInitialize(b,
function(){var a=b.all(".sqs-block.calendar-block[data-block-json]");a.size()&&a.each(function(a){b.Squarespace.Rendering.renderCalendar(a.one(".sqs-block-content"),b.JSON.parse(a.getAttribute("data-block-json")))},this)})},"1.0",{requires:["squarespace-calendar-core-renderer"]});SQUARESPACE_ROLLUPS.push("squarespace-calendar-block-renderer");
